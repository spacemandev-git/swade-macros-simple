{"name":"Fighting","permission":{"default":0,"GVM4OdXsYAEtxw6W":3},"type":"script","flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false}},"scope":"global","command":"// Fighting vs Parry\r\n// Take into account The Drop\r\n\r\nif (canvas.tokens.controlled.length != 1) {\r\n  ui.notifications.warn(\"Please select a single token to use with this Macro\");\r\n}\r\n\r\nif (Array.from(game.user.targets).length != 1) {\r\n  ui.notifications.warn(\"Please select a SINGLE target\");\r\n}\r\n\r\nlet selected = canvas.tokens.controlled[0].actor;\r\nlet target = Array.from(game.user.targets)[0].actor;\r\n\r\nlet meleeWeaponsList = selected.items.filter(\r\n  (el) => el.data.type == \"weapon\" && el.data.data.damage.indexOf(\"@str\") >= 0\r\n);\r\n\r\nlet targetParry = target.data.data.stats.parry.value;\r\nlet targetShields = target.items.filter(\r\n  (el) => el.data.data.equipped && el.data.type == \"shield\"\r\n);\r\n\r\nlet targetParryMod = 0;\r\ntargetShields.map((el) => {\r\n  targetParryMod += parseInt(el.data.data.parry);\r\n});\r\n\r\ngetFightingSolution();\r\n\r\nfunction getFightingSolution() {\r\n  let template = `\r\n  <div class=\"form-group\">\r\n    <p>Target Parry ${targetParry} | Parry Bonus from Shield ${targetParryMod}</p>\r\n    <p></p>\r\n    <p> Has the Drop? <input type=\"checkbox\" id=\"theDrop\" unchecked /> </p>\r\n    <p> Unarmed Defender? <input type=\"checkbox\" id=\"unarmedDefender\" unchecked /> </p>\r\n    <label>Called Shot Mod</label>\r\n    <input type=\"number\" id=\"calledShot\" style=\"width:50px;\" value=0>\r\n    <label> Other Modifiers </label>\r\n    <input type=\"number\" id=\"otherMod\" style=\"width:50px;\" value=0>\r\n\r\n    </div>\r\n  `;\r\n\r\n  new Dialog({\r\n    title: \"Fighting Roll\",\r\n    content: template,\r\n    buttons: {\r\n      ok: {\r\n        label: \"Roll Fighting\",\r\n        callback: async (html) => {\r\n          rollFighting(html);\r\n        },\r\n      },\r\n      cancel: {\r\n        label: \"Cancel\",\r\n      },\r\n    },\r\n  }).render(true);\r\n}\r\n\r\nfunction rollFighting(html) {\r\n  let fightSkill = selected.items.find((el) => el.name == \"Fighting\");\r\n  let rollFormula = \"\";\r\n  let modifier = \"\";\r\n\r\n  // Check if Skill Defined\r\n  // Check if Wildcard\r\n\r\n  if (fightSkill && fightSkill.data.data.die.modifier == \"\") {\r\n    modifier = \"+0\";\r\n  } else if (fightSkill && parseInt(fightSkill.data.data.die.modifier) >= 0) {\r\n    modifier = `+${parseInt(fightSkill.data.data.die.modifier)}`;\r\n  } else if (fightSkill) {\r\n    console.log(\"\");\r\n    modifier = parseInt(fightSkill.data.data.modifier).toString(); // - is baked into a negative\r\n  } else {\r\n    modifier = \"-2\"; //unskilled\r\n  }\r\n\r\n  let otherMods = 0;\r\n  otherMods += parseInt(html.find(\"#otherMod\")[0].value);\r\n  otherMods += parseInt(html.find(\"#calledShot\")[0].value);\r\n  otherMods += html.find(\"#unarmedDefender\")[0].checked ? 2 : 0;\r\n  otherMods += html.find(\"#theDrop\")[0].checked ? 4 : 0;\r\n  otherMods += selected.calcWoundFatigePenalties();\r\n  otherMods += selected.calcStatusPenalties();\r\n  let otherModifier = otherMods >= 0 ? `+${otherMods}` : parseInt(otherMods);\r\n\r\n  if (fightSkill && selected.data.data.wildcard) {\r\n    //WC with Fight Skill\r\n    //console.log(\"WC with Fight Skill\");\r\n    rollFormula = `{1d${fightSkill.data.data.die.sides}x=, 1d${fightSkill.data.data[\"wild-die\"].sides}x=}kh ${modifier} ${otherModifier}`;\r\n  } else if (selected.data.data.wildcard) {\r\n    rollFormula = `{1d4x=, 1d6x=}kh ${modifier} ${otherModifier}`;\r\n    //WC without Fight skill\r\n  } else if (fightSkill) {\r\n    //NPC with Fight Skill\r\n    //console.log(\"NPC with Fight Skill\");\r\n    rollFormula = `1d${fightSkill.data.data.die.sides}x= ${modifier} ${otherModifier}`;\r\n  } else {\r\n    //NPC without Fight Skill\r\n    //console.log(\"NPC \");\r\n    rollFormula = `1d4x= ${modifier} ${otherModifier}`;\r\n  }\r\n\r\n  let roll = new Roll(rollFormula).roll();\r\n  if (game.dice3d) {\r\n    game.dice3d.showForRoll(roll);\r\n  }\r\n\r\n  let numRaises = (roll.total - (targetParry + targetParryMod)) / 4;\r\n\r\n  let chatTemplate = `\r\n  <p> Fighting Skill: ${\r\n    fightSkill ? fightSkill.data.data.die.sides : \"Unskilled\"\r\n  } </p>\r\n  <p> Target Parry (Shield Bonus): ${targetParry}(${targetParryMod}) </p>\r\n  <p> Roll Formula: ${rollFormula} </p>\r\n  <p></p>\r\n  <p> Roll: ${roll.total} </p>\r\n  <p> <b>\r\n  ${numRaises >= 0 ? \"Success\" : \"Did Not Hit\"} \r\n  ${numRaises >= 2 ? `| Raises ${Math.floor(numRaises - 1)}` : \"\"}  \r\n  </b></p>\r\n  `;\r\n\r\n  ChatMessage.create({\r\n    speaker: {\r\n      actor: selected,\r\n      alias: selected.name,\r\n    },\r\n    content: chatTemplate,\r\n  });\r\n}\r\n","author":"GVM4OdXsYAEtxw6W","img":"icons/svg/sword.svg","actorIds":[],"_id":"7Zgu7h1PqVOW7jxw"}
{"name":"Shooting","permission":{"default":0,"GVM4OdXsYAEtxw6W":3},"type":"script","flags":{"combat-utility-belt":{"macroTrigger":""}},"scope":"global","command":"//Get Selected Actor\r\nif (canvas.tokens.controlled.length != 1) {\r\n  ui.notifications.warn(\"Please select a single token to use with this Macro\");\r\n}\r\n\r\nlet selected = canvas.tokens.controlled[0].actor;\r\nlet shootingSkill = selected.items.find((el) => el.data.name == \"Shooting\");\r\nif (shootingSkill == undefined) {\r\n  ui.notifications.warn(\"This actor does not have the Shooting Skill\");\r\n}\r\n\r\n//Ignores melee/wepons that don't have the 'shots' property\r\nlet weapons = selected.items.filter(\r\n  (el) => el.type == \"weapon\" && el.data.data.shots > 0\r\n);\r\n\r\n//SWADE rules for how much ammo is expended per RoF\r\nconst rofAmmo = { 1: 1, 2: 5, 3: 10, 4: 20, 5: 40, 6: 50 };\r\n\r\ngetFiringSolution();\r\n\r\nfunction getFiringSolution() {\r\n  let weaponsDropdown = \"\";\r\n  weapons.forEach((wep) => {\r\n    weaponsDropdown += `<option value=\"${wep.name}\">${wep.name} | ROF ${wep.data.data.rof} | Shots ${wep.data.data.shots} </option>`;\r\n    //console.log(template);\r\n  });\r\n\r\n  let template = `\r\n    <div class=\"form-group\" style=\"display:flex; flex-direction:column;\">\r\n      <p>Select Weapon <select id=\"selectedWeapon\" style=\"\"> ${weaponsDropdown} </select> </p>\r\n      <p> \r\n        Target Cover \r\n        <select id=\"targetCover\" style=\"\">\r\n          <option value=0>No Cover</option>\r\n          <option value=-2>Light</option>\r\n          <option value=-4>Medium</option>\r\n          <option value=-6>Heavy</option>\r\n          <option value=-8>Complete</option>\r\n        </select>\r\n      </p>\r\n      <p>\r\n        Range Penalty\r\n        <select id=\"rangePenalty\" style=\"\">\r\n          <option value=0>Short Range</option>\r\n          <option value=-2>Medium</option>\r\n          <option value=-4>Long</option>\r\n          <option value=-8>Extreme</option>\r\n        </select>\r\n      </p>\r\n      <p>\r\n        Selected RoF\r\n        <input type=\"number\" id=\"selectedRoF\" style=\"width:50px\" value=1>\r\n      </p>\r\n      <p>\r\n        Recoil Penalty\r\n        <input type=\"number\" id=\"recoilPenalty\" style=\" width:50px\" value=0>\r\n      </p>\r\n      <p>\r\n        Multi Action Penalty\r\n        <input type=\"number\" id=\"maPenalty\" style=\"width:50px\" value=0>\r\n      </p>\r\n      <p>\r\n        Has The Drop?\r\n        <input type=\"checkbox\" id=\"theDrop\" syle=\"\" >\r\n      </p>\r\n      <p>\r\n        Other Shooting Modifiers\r\n        <input type=\"number\" id=\"otherMod\" style=\"width:50px\" value=0>\r\n      </p>\r\n      <p>\r\n        Auto Subtract Ammo?\r\n        <input type=\"checkbox\" id=\"trackAmmo\" syle=\"\" checked />\r\n      </p>\r\n    </div>\r\n  `;\r\n\r\n  new Dialog({\r\n    title: \"Ranged Attack\",\r\n    content: template,\r\n    buttons: {\r\n      ok: {\r\n        label: \"Fire Weapon\",\r\n        callback: async (html) => {\r\n          fireWeapon(html);\r\n        },\r\n      },\r\n      cancel: {\r\n        label: \"Cancel\",\r\n      },\r\n    },\r\n  }).render(true);\r\n}\r\n\r\nfunction fireWeapon(html) {\r\n  let weapon = weapons.find(\r\n    (el) => el.name == html.find(\"#selectedWeapon\")[0].value\r\n  );\r\n\r\n  //swade pg93\r\n  let numShootingDie = html.find(\"#selectedRoF\")[0].value;\r\n\r\n  //check if enough Ammo in clip to fire AND if RoF < weapon's RoF\r\n  if (numShootingDie > weapon.data.data.rof || numShootingDie < 1) {\r\n    ui.notifications.warn(\"Selected RoF beyond Weapon RoF\");\r\n    return;\r\n  }\r\n  if (\r\n    html.find(\"#trackAmmo\")[0].checked &&\r\n    rofAmmo[numShootingDie] > weapon.data.data.shots\r\n  ) {\r\n    ui.notifications.warn(\r\n      `Not enough Ammo to fire at this RoF. You only have (${weapon.data.data.shots}) shots left`\r\n    );\r\n    return;\r\n  }\r\n\r\n  let shootingSkillMod = isNaN(parseInt(shootingSkill.data.data.die.modifier))\r\n    ? 0\r\n    : parseInt(shootingSkill.data.data.die.modifier);\r\n  let coverMod = parseInt(html.find(\"#targetCover\")[0].value);\r\n  let recoilMod = parseInt(html.find(\"#recoilPenalty\")[0].value);\r\n  let multiActionMod = parseInt(html.find(\"#maPenalty\")[0].value);\r\n  let rangeMod = parseInt(html.find(\"#rangePenalty\")[0].value);\r\n  let otherMod = parseInt(html.find(\"#otherMod\")[0].value);\r\n  let theDropMod = html.find(\"#theDrop\")[0].checked ? 4 : 0;\r\n  let woundMod = selected.calcWoundFatigePenalties();\r\n  let statusMod = selected.calcStatusPenalties();\r\n\r\n  let totalMod =\r\n    shootingSkillMod +\r\n    coverMod +\r\n    recoilMod +\r\n    multiActionMod +\r\n    rangeMod +\r\n    otherMod +\r\n    theDropMod +\r\n    woundMod +\r\n    statusMod;\r\n\r\n  let tModStr = totalMod >= 0 ? `+${totalMod}` : `${totalMod}`;\r\n\r\n  let rollString = `1d${shootingSkill.data.data.die.sides}x= ${tModStr}`;\r\n  let wildString = `1d${shootingSkill.data.data[\"wild-die\"].sides}x= ${tModStr}`;\r\n\r\n  let rolls = [];\r\n  let results = [];\r\n  for (let i = 0; i < numShootingDie; i++) {\r\n    let roll = new Roll(rollString).roll();\r\n    if (game.dice3d) {\r\n      game.dice3d.showForRoll(roll);\r\n    }\r\n    rolls.push(roll.total);\r\n    results.push(roll.total);\r\n  }\r\n\r\n  let wildRoll;\r\n  if (selected.data.data.wildcard) {\r\n    wildRoll = new Roll(wildString).roll();\r\n    if (game.dice3d) {\r\n      game.dice3d.showForRoll(wildRoll);\r\n    }\r\n    results.push(wildRoll.total);\r\n    results.splice(results.indexOf(Math.min(...results)), 1); //drop lowest after adding in Wild Roll\r\n  }\r\n\r\n  //update Ammo\r\n  if (html.find(\"#trackAmmo\")[0].checked) {\r\n    let newShots = (weapon.data.data.shots -= rofAmmo[numShootingDie]);\r\n    weapon.update({ \"data.shots\": newShots });\r\n  }\r\n\r\n  let chatTemplate = `\r\n  <p>Weapon: ${weapon.data.name}</p>\r\n  <p>Notes: ${weapon.data.data.notes}</p>\r\n  <p>Shots Left: ${weapon.data.data.shots}</p>\r\n  <p></p>\r\n  <p>\r\n    Shooting Rolls: [${rolls}] \r\n    ${selected.data.data.wildcard ? ` | Wild Die Roll: ${wildRoll.total}` : \"\"}\r\n  </p>\r\n  <p>Roll String: ${rollString}</p>\r\n  <p></p>\r\n  <p>\r\n    Results: <b>[${results}]</b>\r\n  </p>\r\n  `;\r\n\r\n  ChatMessage.create({\r\n    speaker: {\r\n      actor: selected,\r\n      alias: selected.name,\r\n    },\r\n    content: chatTemplate,\r\n  });\r\n}\r\n","author":"GVM4OdXsYAEtxw6W","img":"icons/svg/target.svg","actorIds":[],"_id":"fedFk02vxLmEpg1O"}
{"name":"Damage","permission":{"default":0,"GVM4OdXsYAEtxw6W":3},"type":"script","flags":{"combat-utility-belt":{"macroTrigger":""},"furnace":{"runAsGM":false}},"scope":"global","command":"//Get Selected Actor\r\nif (canvas.tokens.controlled.length != 1) {\r\n  ui.notifications.warn(\"Please select a single token to use with this Macro\");\r\n}\r\n\r\n//Get Target Actor\r\nif (Array.from(game.user.targets).length != 1) {\r\n  ui.notifications.warn(\"Please select a SINGLE target\");\r\n}\r\n\r\nlet selected = canvas.tokens.controlled[0].actor;\r\nlet target = Array.from(game.user.targets)[0].actor;\r\n\r\nlet selectedWeaponsList = selected.items.filter(\r\n  (el) => el.data.type == \"weapon\" && el.data.data.equipped\r\n);\r\n//weapons dmg roll:\r\n//let roll = new Roll(itemData.damage, actor.getRollShortcuts()).roll();\r\n\r\nlet targetArmors = target.items.filter(\r\n  (el) => el.data.data.equipped && el.data.type == \"armor\"\r\n);\r\nlet targetArmor = 0;\r\ntargetArmors.map((el) => {\r\n  targetArmor += parseInt(el.data.data.armor);\r\n});\r\n\r\nlet targetToughenss = target.data.data.stats.toughness; //{toughness =\"\", armor: #, mod: #}\r\n// console.log(targetToughenss);\r\nrollDamage();\r\nfunction rollDamage() {\r\n  //| Other Mods: ${targetToughenss.modifier}\r\n  let template = `\r\n  <div>\r\n    <p><b>Selected Token Information</b></p>\r\n    <div class = \"form-group\">\r\n    <label>Select Weapon</label>\r\n    <select id=\"selectedWeapon\">\r\n    ${getWeaponsList()}\r\n    </select>\r\n    <p></p>\r\n    <p><b>Target Information</b></p>\r\n    <p>Base Toughness: ${targetToughenss.value} | Armor: ${targetArmor} </p> \r\n    <p>Armor Notes: </p>\r\n    ${getTargetArmorNotes()}\r\n    <p>Ignore Armor: <input type=\"checkbox\" id=\"ignoreArmor\"></input></p>    \r\n    <p></p>\r\n    <p><b>Other Modifiers</b></p>\r\n    <p>\r\n    <label>Has the Drop?</label>\r\n    <input type=\"checkbox\" id=\"hasDrop\"></input>\r\n    <label>Roll Bonus Damage?</label>\r\n    <input type=\"checkbox\" id=\"bonusDmg\"></input>\r\n    </p>\r\n\r\n    <p>\r\n    <label> Other Damage Mod </label>\r\n    <input type=\"number\" id=\"dmgMod\" value=0 style=\"width:50px\"></input>\r\n    </p>\r\n    </div>\r\n  </div>\r\n  `;\r\n\r\n  new Dialog({\r\n    title: \"Damage Roll\",\r\n    content: template,\r\n    buttons: {\r\n      ok: {\r\n        label: \"Roll Damage\",\r\n        callback: async (html) => {\r\n          dealDamage(html);\r\n        },\r\n      },\r\n      cancel: {\r\n        label: \"Cancel\",\r\n      },\r\n    },\r\n  }).render(true);\r\n}\r\n\r\nfunction getWeaponsList() {\r\n  let template = ``;\r\n  selectedWeaponsList.forEach((wep) => {\r\n    template += `<option value=\"${wep.name}\">${wep.name} | AP ${wep.data.data.ap} | DMG: ${wep.data.data.damage}</option>`;\r\n  });\r\n\r\n  return template;\r\n}\r\nfunction getTargetArmorNotes() {\r\n  let template = ``;\r\n  targetArmors.forEach((armor) => {\r\n    template += `<p>${armor.name} | ${armor.data.data.notes}</p>`;\r\n  });\r\n  return template;\r\n}\r\n\r\nfunction dealDamage(html) {\r\n  let selectedWeapon = selectedWeaponsList.find(\r\n    (el) => el.name == html.find(\"#selectedWeapon\")[0].value\r\n  );\r\n\r\n  let parts = selectedWeapon.data.data.damage.split(\"+\");\r\n  parts = parts.map((part) => {\r\n    if (part.indexOf(\"d\") > -1) {\r\n      return `${part}x=`;\r\n    } else {\r\n      return part;\r\n    }\r\n  });\r\n\r\n  let wepDmgRoll = \"\";\r\n  for (let i = 0; i < parts.length; i++) {\r\n    if (i != parts.length - 1) {\r\n      wepDmgRoll += `${parts[i]} +`;\r\n    } else {\r\n      wepDmgRoll += parts[i];\r\n    }\r\n  }\r\n  let dmgMod =\r\n    parseInt(html.find(\"#dmgMod\")[0].value) +\r\n    (html.find(\"#hasDrop\")[0].checked ? 4 : 0);\r\n\r\n  let rollString =\r\n    wepDmgRoll +\r\n    (html.find(\"#bonusDmg\")[0].checked ? \" +1d6x=\" : \"\") +\r\n    (dmgMod >= 0 ? ` +${dmgMod}` : ` ${dmgMod}`);\r\n\r\n  let roll = new Roll(rollString, actor.getRollShortcuts()).roll();\r\n  if (game.dice3d) {\r\n    game.dice3d.showForRoll(roll);\r\n  }\r\n\r\n  let armorAfterAP = targetArmor - selectedWeapon.data.data.ap;\r\n  armorAfterAP = armorAfterAP < 0 ? 0 : armorAfterAP;\r\n\r\n  let tough =\r\n    parseInt(targetToughenss.value) +\r\n    (html.find(\"#ignoreArmor\")[0].checked ? 0 : armorAfterAP); // + targetToughenss.modifier;\r\n\r\n  let dmg = roll.total - tough;\r\n  let numSuccesses = dmg / 4;\r\n\r\n  //The Success/Raise calculation is intentionally different than other macros\r\n  let result = `\r\n  <p>Weapon: ${selectedWeapon.name} | AP ${selectedWeapon.data.data.ap}</p>\r\n  <p>Roll String: ${rollString}</p>\r\n  <p>Damage Roll: ${roll.total}</p>\r\n  <p>Target Toughness After AP: ${tough}</p>\r\n  <p></p>\r\n  <p>Damage dealt: <b>${dmg}</b></p>\r\n  <p><b>\r\n  ${numSuccesses >= 0 ? \"Success\" : \"No Damage\"} \r\n  ${numSuccesses >= 1 ? `| Raises ${Math.floor(numSuccesses)}` : \"\"}  \r\n  </b></p>\r\n  `;\r\n\r\n  ChatMessage.create({\r\n    speaker: {\r\n      actor: selected,\r\n      alias: selected.name,\r\n    },\r\n    content: result,\r\n  });\r\n}\r\n","author":"GVM4OdXsYAEtxw6W","img":"icons/svg/dice-target.svg","actorIds":[],"_id":"jvrqZthcEBFZqSeS"}
{"name":"Nnayl AIO Macro","permission":{"default":0,"siZAYn2xsyMeEsfz":3},"type":"script","flags":{},"scope":"global","command":"let isValidConditions = true;\r\nlet diceStep = [\"d4\", \"d6\", \"d8\", \"d10\", \"d12\"];\r\nlet currentActor;\r\n\r\n//Uses the selected actor to figure out guns\r\nif (canvas.tokens.controlled.length != 1) {\r\n    ui.notifications.warn(\"To attack you need to select a token\");\r\n    isValidConditions = false;\r\n}else{\r\n    // Set Actor\r\n    currentActor = canvas.tokens.controlled[0].actor;\r\n\r\n    // Check shaken state\r\n    if (currentActor.data.data.status.isShaken) {\r\n        ui.notifications.warn(\"You are shaken, you can't attack\");\r\n        isValidConditions = false;\r\n    }\r\n}\r\n\r\n// Check target selected\r\nif (Array.from(game.user.targets).length != 1) {\r\n    ui.notifications.warn(\"To attack you need to select a target\");\r\n    isValidConditions = false;\r\n}\r\n\r\nlet currentTarget;\r\nlet weapons;\r\n\r\n// Attack type choice\r\nif (isValidConditions) {\r\n        // Set actor target\r\n    currentTarget = Array.from(game.user.targets)[0].actor;\r\n\r\n    // Set weapons list\r\n    weapons = currentActor.items.filter((el) => el.type == \"weapon\" && el.data.data.equipped);\r\n\r\n    new Dialog({\r\n        title: \"Combat\",\r\n        content: `<div style=\"padding: 10px 0px 10px 0px;\"><center><i>Please, choose one attack type</i></center></div>`,\r\n        buttons: {\r\n            contact: {\r\n                label: \"Melee\",\r\n                callback: async (html) => {\r\n                    meleeAttackForm(html);\r\n                },\r\n            },\r\n            ranged: {\r\n                label: \"Range\",\r\n                callback: async (html) => {\r\n                    rangedAttackForm(html);\r\n                },\r\n            }\r\n        },\r\n    }, { width: 400 }).render(true);\r\n}\r\n\r\n//Utility function for printing things to chat\r\nfunction printMessage(message) {\r\n    ChatMessage.create(\r\n        {\r\n        speaker: {\r\n            actor: currentActor,\r\n            alias: currentActor.name,\r\n        },\r\n        content: message,\r\n        },\r\n        {}\r\n    );\r\n} // end  printMessage\r\n\r\n// Add EventListener to a html element\r\nfunction addEventListenerOnHtmlElement(element, event, func){\r\n    // Use Hook to add event to chat message html element\r\n    Hooks.once(\"renderChatMessage\", (chatItem, html) => { \r\n        html[0].querySelector(element).addEventListener(event, func);\r\n    });\r\n} // end addEventListenerOnHtmlElement\r\n\r\n// melee attack form\r\nfunction meleeAttackForm(){\r\n    let templateWeaponsList = ``;\r\n\r\n    // generate html template weapons list\r\n    weapons.forEach((wep) => {\r\n        if (wep.data.data.range == \"0\" || wep.data.data.range == \"\") \r\n        {\r\n            templateWeaponsList += `<option value=\"${wep.name}\">${wep.name} | Damage ${wep.data.data.damage} </option>`;\r\n        }\r\n    });\r\n\r\n    // Check if template is not empty\r\n    if (templateWeaponsList.length == 0) {\r\n        ui.notifications.warn(\"No disponible weapon for this attack type\");\r\n        isValidConditions = false;\r\n    }\r\n\r\n    let template = `\r\n    <div style=\"display: flex; flex-wrap: wrap; flex-direction: row; justify-content: space-between\">\r\n        <div style=\"padding: 0px 0px 5px 0px\">\r\n            <label style=\"display: inline-block; width: 200px\">Weapons : </label>\r\n            <select id=\"selectedWeapon\">\r\n            ${templateWeaponsList}\r\n            </select>\r\n        </div>\r\n        <div style=\"padding: 0px 0px 5px 0px\">\r\n            <label for=\"targetCover\" style=\"display: inline-block; width: 200px\">Target cover : </label>\r\n            <select id=\"targetCover\">\r\n            <option value=\"0\">No cover</option>\r\n            <option value=\"-2\">Light</option>\r\n            <option value=\"-4\">Medium</option>\r\n            <option value=\"-6\">Heavy</option>\r\n            <option value=\"-8\">Near total</option>\r\n            </select>\r\n        </div>\r\n        <div style=\"padding: 0px 0px 5px 0px\">\r\n            <label for=\"otherMod\" style=\"display: inline-block; width: 200px\">Other mods :\r\n            </label> <input id=\"otherMod\" style=\"width: 50px;\" type=\"number\" value=\"0\" /></div>\r\n        </div>\r\n    <div>\r\n    <div style=\"padding: 0px 0px 5px 0px; text-align: center;\">\r\n        <i><label>Status and size scale are automated</label></i>\r\n    </div>`;\r\n  \r\n    if (isValidConditions) {\r\n        // Show form\r\n        new Dialog({\r\n            title: \"Melee Attack\",\r\n            content: template,\r\n            buttons: {\r\n                ok: {\r\n                    label: \"Attack\",\r\n                    callback: async (html) => {\r\n                    commitAttack({ html, attackSkillName : \"Fighting\" });\r\n                    },\r\n                },\r\n                cancel: {\r\n                    label: \"Cancel\",\r\n                },\r\n            },\r\n            default: \"ok\",\r\n        }, { width: 550 }).render(true);\r\n    }\r\n} // end contactAttackForm\r\n\r\n// Ranged attack form\r\nfunction rangedAttackForm(){\r\n    let templateWeaponsList = ``;\r\n\r\n    // generate html template weapons list\r\n    weapons.forEach((wep) => {\r\n        if (wep.data.data.range != \"0\" && wep.data.data.range != \"\") \r\n        {\r\n            templateWeaponsList += `<option value=\"${wep.name}\">${wep.name} | RoF ${wep.data.data.rof} | shots ${wep.data.data.shots} </option>`;\r\n        }\r\n    });\r\n\r\n    // Check if template is not empty\r\n    if (templateWeaponsList.length == 0) {\r\n        ui.notifications.warn(\"No disponible weapon for this attack type\");\r\n        isValidConditions = false;\r\n    }\r\n\r\n    let template = `\r\n    <div style=\"display: flex; flex-wrap: wrap; flex-direction: row; justify-content: space-between\">\r\n        <div style=\"padding: 0px 0px 5px 0px\">\r\n            <label style=\"display: inline-block; width: 200px\">Weapons : </label>\r\n            <select id=\"selectedWeapon\">\r\n                ${templateWeaponsList}\r\n            </select>\r\n        </div>\r\n        <div style=\"padding: 0px 0px 5px 0px\">\r\n            <label for=\"rangePenalty\" style=\"display: inline-block; width: 200px\">Target range : </label>\r\n            <select id=\"rangePenalty\">\r\n                <option value=\"0\">Short</option>\r\n                <option value=\"-2\">Medium</option>\r\n                <option value=\"-4\">Long</option>\r\n                <option value=\"-8\">Extrem</option>\r\n            </select>\r\n        </div>\r\n        <div style=\"padding: 0px 0px 5px 0px\">\r\n            <label for=\"targetCover\" style=\"display: inline-block; width: 200px\">Target cover : </label>\r\n            <select id=\"targetCover\">\r\n                <option value=\"0\">No cover</option>\r\n                <option value=\"-2\">Light</option>\r\n                <option value=\"-4\">Medium</option>\r\n                <option value=\"-6\">Heavy</option>\r\n                <option value=\"-8\">Near total</option>\r\n            </select>\r\n        </div>\r\n        <div style=\"padding: 0px 0px 5px 0px\">\r\n            <label for=\"selectedRoF\" style=\"display: inline-block; width: 200px\">Rate of fire : </label>\r\n            <select id=\"selectedRoF\" style=\"width: 50px;\">\r\n                <option value=\"1\">1</option>\r\n                <option value=\"2\">2</option>\r\n                <option value=\"3\">3</option>\r\n                <option value=\"4\">4</option>\r\n                <option value=\"5\">5</option>\r\n                <option value=\"6\">6</option>\r\n            </select>\r\n        </div>\r\n        <div style=\"padding: 0px 0px 5px 0px\">\r\n            <label for=\"isRecoil\" style=\"display: inline-block; width: 200px; margin-bottom: 3px; vertical-align: bottom;\">Recoil penality : </label>\r\n            <input id=\"isRecoil\" style=\"width: 43px; height: 15px;\" type=\"checkbox\" />\r\n        </div>\r\n        <div style=\"padding: 0px 0px 5px 0px\">\r\n            <label for=\"otherMod\" style=\"display: inline-block; width: 200px\">Other mods : </label>\r\n            <input id=\"otherMod\" style=\"width: 50px;\" type=\"number\" value=\"0\" />\r\n        </div>\r\n        <div style=\"padding: 0px 0px 5px 0px\">\r\n            <label for=\"isUnstable\" style=\"display: inline-block; width: 200px; margin-bottom: 3px; vertical-align: bottom;\">Unstable : </label>\r\n            <input id=\"isUnstable\" style=\"width: 43px; height: 15px;\" type=\"checkbox\" />\r\n        </div>\r\n    </div>\r\n    <div style=\"padding: 0px 0px 5px 0px; text-align: center;\">\r\n        <i><label>Status and size scale are automated</label></i>\r\n    </div>`;\r\n    \r\n    // Show form\r\n    if (isValidConditions) {\r\n        new Dialog({\r\n            title: \"Attaque Ã  Distance\",\r\n            content: template,\r\n            buttons: {\r\n                ok: {\r\n                label: \"Attaquer\",\r\n                callback: async (html) => {\r\n                    commitAttack({ html, attackSkillName : \"Shooting\" });\r\n                },\r\n                },\r\n                cancel: {\r\n                label: \"Annuler\",\r\n                },\r\n            },\r\n            default: \"ok\",\r\n        },{ width: 550 }).render(true);\r\n    }\r\n    \r\n} // end rangedAttackForm\r\n\r\n// Settings for damage outpout\r\nfunction damageSettings(params, eventTarget)\r\n{\r\n    let template = `\r\n    <div><p style=\"text-align: center\">Apply some settings for damage roll</p></div>\r\n    <div style=\"display: flex; flex-wrap: wrap; flex-direction: row; justify-content: space-between\">\r\n        <div style=\"padding: 0px 0px 5px 0px;\">\r\n            <label for=\"coverBonus\" style=\"display: inline-block; width: 200px\">Obstacle armor bonus : </label>\r\n            <select id=\"coverBonus\" style=\"width: 50px;\">\r\n                <option value=\"0\">0</option>    \r\n                <option value=\"2\">2</option>\r\n                <option value=\"4\">4</option>\r\n                <option value=\"6\">6</option>\r\n                <option value=\"8\">8</option>\r\n                <option value=\"10\">10</option>\r\n            </select>\r\n        </div>\r\n        <div style=\"padding: 0px 0px 5px 0px;\">\r\n            <label for=\"ignoreArmor\" style=\"display: inline-block; width: 200px; margin-bottom: 3px; vertical-align: bottom;\">Ignore target armor : </label>\r\n            <input id=\"ignoreArmor\" style=\"width: 43px; height: 15px;\" type=\"checkbox\" />\r\n        </div>\r\n        <div style=\"padding: 0px 0px 5px 0px;\">\r\n            <label for=\"damageMod\" style=\"display: inline-block; width: 200px\">Damage modification : </label>\r\n            <input id=\"damageMod\" style=\"width: 50px;\" type=\"number\" value=\"0\" />\r\n        </div>\r\n        <div style=\"padding: 0px 0px 5px 0px;\">\r\n            <label for=\"isGrettyDamage\" style=\"display: inline-block; width: 200px; margin-bottom: 3px; vertical-align: bottom;\">Apply gritty damage : </label>\r\n            <input id=\"isGrettyDamage\" style=\"width: 43px; height: 15px;\" type=\"checkbox\" />\r\n        </div>\r\n    </div>`;\r\n    \r\n    new Dialog({\r\n        title: \"Damage Settings\",\r\n        content: template,\r\n        buttons: {\r\n            ok: {\r\n            label: \"Confirm\",\r\n            callback: async (html) => {\r\n                eventTarget.style.display = \"none\";\r\n                params.html = html;\r\n                damageCalculation(params);\r\n            },\r\n            },\r\n            cancel: {\r\n            label: \"Cancel\",\r\n            },\r\n        },\r\n        default: \"ok\",\r\n    },{ width: 540 }).render(true);    \r\n} //end damageSettings\r\n\r\n//Attack process\r\nfunction commitAttack(params)\r\n{\r\n\r\n    let html = params.html;\r\n    let attackSkillName = params.attackSkillName;\r\n    let bennieUsed = params.bennieUsed;\r\n\r\n    console.log(bennieUsed);\r\n\r\n    //SWADE rules for how much ammo is expended per RoF\r\n    let rofAmmo = { 1: 1, 2: 5, 3: 10, 4: 20, 5: 40, 6: 50 };\r\n    \r\n    //SWADE rules SizeScale\r\n    let sizeScale = [\r\n        {size: -4, mod : -6}, {size: -3, mod : -4}, {size: -2, mod : -2}, {size: -1, mod : 0},\r\n        {size: 0, mod : 0}, {size: 1, mod : 0}, {size: 2, mod : 0}, {size: 3, mod : 0},\r\n        {size: 4, mod : 2}, {size: 5, mod : 2}, {size: 6, mod : 2}, {size: 7, mod : 2},\r\n        {size: 8, mod : 4}, {size: 9, mod : 4}, {size: 10, mod : 4}, {size: 11, mod : 4},\r\n        {size: 12, mod : 6}, {size: 13, mod : 6}, {size: 14, mod : 6}, {size: 15, mod : 6},\r\n        {size: 16, mod : 6}, {size: 17, mod : 6}, {size: 18, mod : 6}, {size: 19, mod : 6}, {size: 20, mod : 6}\r\n      ];\r\n\r\n    \r\n    // Get weapon selected\r\n    let weapon = weapons.find((el) => el.name == html.find(\"#selectedWeapon\")[0].value);\r\n\r\n    // Get number of attack if a ranged attack or set to 1 for melee attack\r\n    let numAttack = html.find(\"#selectedRoF\")[0] === undefined ? 1 : html.find(\"#selectedRoF\")[0].value;\r\n\r\n    // Get skill need for attack\r\n    let attackSkill = currentActor.items.find((el) => el.data.name == attackSkillName);\r\n    \r\n    // Simulate unskilled skill when the attack skill is not found\r\n    if (attackSkill === null) attackSkill = { data : { data : { die : { sides : 4, modifier: -2 }, \"wild-die\" : { sides : 6 }  } } };\r\n    \r\n    //Some check for Ranged Attack\r\n    if (attackSkillName == \"Shooting\") {\r\n\r\n        // Check RoF\r\n        if ((numAttack > weapon.data.data.rof)) {\r\n            ui.notifications.warn(\"You need to select a valid RoF for your weapon\");\r\n            isValidConditions = false;\r\n        };\r\n        \r\n        // Check ammo\r\n        if (rofAmmo[numAttack] > weapon.data.data.shots) {\r\n            ui.notifications.warn(`No munition for this rate of fore, you have (${weapon.data.data.shots}) ammo left`);\r\n            isValidConditions = false;\r\n        };\r\n    };\r\n\r\n    let diceResultPool = [];\r\n    // Roll Dices\r\n    for (let i = 0; i < numAttack; i++) {\r\n        diceResultPool.push({ type: \"skillRoll\", roll : new Roll(\"1d\" + attackSkill.data.data.die.sides + \"x=\").roll(), saved : 1});\r\n    }\r\n\r\n    // Roll Wild for Joker\r\n    // Last entities in dicePoolResult is Wild\r\n    if (currentActor.data.data.wildcard) {\r\n        diceResultPool.push({ type: \"wildRoll\", roll : new Roll(\"1d\" + attackSkill.data.data[\"wild-die\"].sides + \"x=\").roll(), saved : 1});\r\n    }\r\n\r\n    // Unsaved lesser result from Dice Pool\r\n    if (diceResultPool.length > 1)\r\n        diceResultPool[diceResultPool.findIndex((el) => el.roll.total == Math.min(...diceResultPool.map((el) => el.roll.total)))].saved = 0;\r\n\r\n    // Build Modifiers\r\n    let skillModPool = [];\r\n    skillModPool.push({ mod : \"skilled\", value : !parseInt(attackSkill.data.data.die.modifier) ? 0 : parseInt(attackSkill.data.data.die.modifier) });\r\n    skillModPool.push({ mod : \"rangePenalty\", value : html.find(\"#rangePenalty\")[0] === undefined ? 0 : parseInt(html.find(\"#rangePenalty\")[0].value) });\r\n    skillModPool.push({ mod : \"targetCover\", value : html.find(\"#targetCover\")[0] === undefined ? 0 : parseInt(html.find(\"#targetCover\")[0].value) });\r\n    skillModPool.push({ mod : \"isRecoil\", value : html.find(\"#isRecoil\")[0] === undefined ? 0 : html.find(\"#isRecoil\")[0].checked ? -2 : 0 });\r\n    skillModPool.push({ mod : \"otherMod\", value : html.find(\"#otherMod\")[0] === undefined ? 0 : parseInt(html.find(\"#otherMod\")[0].value) });\r\n    skillModPool.push({ mod : \"isUnstable\", value : html.find(\"#isUnstable\")[0] === undefined ? 0 : html.find(\"#isUnstable\")[0].checked ? -2 : 0 });\r\n    skillModPool.push({ mod : \"distracted\", value : currentActor.data.data.status.isDistracted ? -2 : 0});\r\n    skillModPool.push({ mod : \"vulnerable\", value : currentTarget.data.data.status.isVulnerable ? 2 : 0});\r\n    skillModPool.push({ mod : \"woundsFatigue\", value : currentActor.calcWoundFatigePenalties()});\r\n    skillModPool.push({ mod : \"sizeScale\", value : (sizeScale[sizeScale.findIndex((el) => el.size == currentActor.data.data.stats.size)].mod * -1) + sizeScale[sizeScale.findIndex((el) => el.size == currentTarget.data.data.stats.size)].mod });\r\n    if (attackSkillName == \"Shooting\") \r\n    { \r\n        skillModPool.push({ mod : \"minStrength\", value : weapon.data.data.minStr == \"\" ? 0 : diceStep.indexOf(weapon.data.data.minStr) > diceStep.indexOf((\"d\" + currentActor.data.data.attributes.strength.die.sides)) ? diceStep.indexOf((\"d\" + currentActor.data.data.attributes.strength.die.sides)) - diceStep.indexOf(weapon.data.data.minStr) : 0});\r\n    }\r\n\r\n    // Set Total modifications variable\r\n    let totalMod = 0;\r\n    skillModPool.forEach((el) =>  totalMod += el.value );\r\n\r\n    let displaySuccessResultTemplate = ``;\r\n    let displayRollResultTemplate = ``;\r\n    let successResultPool = [];\r\n\r\n    // Create roll result template\r\n    diceResultPool.forEach((el) => {\r\n        displayRollResultTemplate +=\r\n        `<div style=\"flex: 1 0 auto;\">\r\n                <div style=\"padding: 3px 0px 3px 0px; box-shadow: 0 0 2px #FFF inset; border-radius: 3px; ${ el.type == \"wildRoll\" ? \"background-color: rgb(255,215,0, 0.35);\" : el.roll.total > el.roll.parts[0].faces ? \"background-color : rgb(0, 200, 0, 0.35)\" : el.roll.total == 1 ? \"background-color : rgb(255, 0, 0, 0.35)\" : \"\" } \"><label title=\"\" style=\"color: white;\">${ el.roll.total }</label></div>\r\n            </div>`;\r\n    });\r\n\r\n    // Check if critical failure !\r\n    let criticalFailure = (diceResultPool.filter((el) => el.roll.total == 1).length > (diceResultPool.length / 2)) && (!currentActor.data.data.wildcard || diceResultPool.find((el) => el.type == \"wildRoll\" && el.roll.total == 1) !== undefined);\r\n    if (criticalFailure){\r\n        displaySuccessResultTemplate += \r\n        `<div style=\"flex: 1 0 auto;\">\r\n            <div style=\"padding: 3px 0px 3px 0px; box-shadow: 0 0 2px #FFF inset; border-radius: 3px; background-color : rgb(255, 0, 0, 0.35)\"><label style=\"color : rgb(200, 0, 0);\">!! Critical Failure !!</label></div>\r\n        </div>`;\r\n    }\r\n    else\r\n    {\r\n        // Create roll interpretation template\r\n        diceResultPool.filter((el) => el.saved).forEach((el) =>{\r\n\r\n            let result = (el.roll.total + totalMod) >= (attackSkillName == \"Shooting\" ? 4 : parseInt(currentTarget.data.data.stats.parry.value)) + 4 ? { display : \"Raise\", color : \"rgb(0, 0, 255, 0.35)\" } :\r\n                            (el.roll.total + totalMod) >= (attackSkillName == \"Shooting\" ? 4 : parseInt(currentTarget.data.data.stats.parry.value)) ? { display : \"Hit\", color : \"rgb(0, 200, 0, 0.35)\" } : { display : \"Miss\", color : \"rgb(255, 0, 0, 0.35)\" }\r\n            \r\n            if (result.display != \"Miss\") successResultPool.push(result.display);\r\n            \r\n            displaySuccessResultTemplate += \r\n                `<div style=\"flex: 1 0 auto;\">\r\n                    <div style=\"padding: 3px 0px 3px 0px; box-shadow: 0 0 2px #FFF inset; border-radius: 3px; background-color : ${ result.color }\"><label title=\"${ el.roll.total} (${ el.roll.total + totalMod })\" style=\"color : white;\">${ result.display }</label></div>\r\n                </div>`;\r\n        });\r\n    }\r\n\r\n    //Message chat template\r\n    let chatTemplate = $(\r\n    `<div>\r\n        <div style=\"display: flex; align-items: center;\">\r\n            <div style=\"width: 52px; flex: 0 0 52px;\">\r\n                <img src=\"${weapon.data.img}\"></img>\r\n            </div>\r\n            <div style=\"padding-left: 5px;\">\r\n                <span>Attack against <b>${currentTarget.data.name}</b> with the weapon <b>${weapon.data.name}</b></span>\r\n            </div>\r\n        </div>\r\n        ${ attackSkillName == \"Shooting\" ? `<p><i><b>${ rofAmmo[numAttack] }</b> ammo used</i></p>` : \"\" }\r\n        <p><i>Notes : ${weapon.data.data.notes}</i></p>\r\n        ${ bennieUsed ? `<p style=\"text-align: center\"><b>One bennie used for reroll attack</b></p>` : \"\" }\r\n        <div style=\"border: 1px solid #999; display: flex; box-shadow: 0 0 2px #FFF inset; background: rgba(255, 255, 240, 0.8); margin-bottom: 5px; text-align: center;\">\r\n                <div style=\"flex-grow: 1; padding-bottom: 2px; padding-top: 2px;\"><span>Diff. : </span><span>${ attackSkillName == \"Shooting\" ? \"4\" : currentTarget.data.data.stats.parry.value }</span></div>\r\n                <div style=\"flex-grow: 1; padding-bottom: 2px; padding-top: 2px;\" title=\"${ skillModPool.map((el) => el.mod + \" : \" + el.value).join(\"\\n\") }\"><span>Mod : </span><span>${totalMod}</span></div>\r\n        </div>\r\n        <div style=\"border: 1px solid #999; border-radius: 3px; box-shadow: 0 0 2px #FFF inset; background: rgba(0, 0, 0, 0.1); text-align: center;\">\r\n            <div style=\"display: flex; flex-wrap: wrap;\">\r\n                <div style=\"box-shadow: 0 0 2px #FFF inset; display: flex; flex-direction: column; text-align: center; flex: 1 100 auto; width: 100%\">\r\n                    <div style=\"padding: 5px 0px 5px 0px; background: rgba(255, 255, 240, 0.8);\">\r\n                        <label><b>Roll</b></label>\r\n                    </div>\r\n                    <div style=\"display: flex; flex-wrap: wrap; font-size: 16px; font-weight: bold\">\r\n                        ${displayRollResultTemplate}\r\n                    </div>\r\n                </div>\r\n                <div style=\"box-shadow: 0 0 2px #FFF inset; display: flex; flex-direction: column; text-align: center; flex: 1 100 auto; width: 100%\">\r\n                    <div style=\"padding: 5px 0px 5px 0px; background: rgba(255, 255, 240, 0.8);\">\r\n                        <label><b>Result</b></label>\r\n                    </div>\r\n                    <div style=\"display: flex; flex-wrap: wrap; font-size: 16px; font-weight: bold\">\r\n                        ${displaySuccessResultTemplate}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>`);\r\n    \r\n    if (isValidConditions) {\r\n\r\n        // Apply bennie button and listener to chatTemplate if not critical failure\r\n        if (!criticalFailure) {\r\n            let bennieButtonTemplate = $(\r\n                `<div style=\"display: flex; padding-top: 5px;\">\r\n                <button id=\"reRollButton\"><center>Reroll with a Bennie</center></button>\r\n                </div>`\r\n            );\r\n        \r\n            chatTemplate.append(bennieButtonTemplate);\r\n\r\n            // Add event to chat message html element\r\n            addEventListenerOnHtmlElement(\"#reRollButton\", 'click', (e) => { \r\n                e.target.style.display = \"none\"; \r\n                params.bennieUsed = true;\r\n                commitAttack(params);\r\n            }); \r\n        }\r\n        \r\n         // Apply damage button and listener to chatTemplate if 1+ success\r\n        if (successResultPool.length > 0) {\r\n            let damageButtonTemplate = $(\r\n                `<div style=\"display: flex; padding-top: 5px;\">\r\n                <button id=\"callDamageButton\"><center>Apply damage</center></button>\r\n                </div>`\r\n            );\r\n            \r\n            chatTemplate.append(damageButtonTemplate);\r\n\r\n            // Add event to chat message html element\r\n            addEventListenerOnHtmlElement(\"#callDamageButton\", 'click', (e) => { \r\n                damageSettings({weapon, successResultPool, attackSkillName}, e.target);\r\n            }); \r\n        }\r\n\r\n        // Displat chat template\r\n        // Check can use \"So Nice Dices\" mod effects\r\n        game.dice3d === undefined ? printMessage(chatTemplate[0].outerHTML) : game.dice3d.showForRoll(diceResultPool.map((el) => el.roll)).then(displayed => {\r\n            printMessage(chatTemplate[0].outerHTML);\r\n        });   \r\n    }\r\n}// end commitAttack\r\n\r\n// Calcul and display damages\r\nfunction damageCalculation(params) //weapon, successResultPool, attackSkillName)\r\n{\r\n    let weapon = params.weapon;\r\n    let successResultPool = params.successResultPool;\r\n    let attackSkillName = params.attackSkillName;\r\n    let bennieUsed = params.bennieUsed;\r\n    let html = params.html;\r\n\r\n    // SWADE rule, injury table page 95\r\n    let criticalInjury = [\r\n        { value : [ 2 ], injury : \"Unmentionables\", subInjury : undefined },\r\n        { value : [ 3, 4 ], injury : \"Arm\", subInjury : undefined },\r\n        { value : [ 5, 6, 7, 8, 9 ], injury : \"Guts\", subInjury : [\r\n            { value : [ 1, 2 ], injury : \"Broken\" },\r\n            { value : [ 3, 4 ], injury : \"Battered\" },\r\n            { value : [ 5, 6 ], injury : \"Busted\" }\r\n        ]},\r\n        { value : [ 10, 11 ], injury : \"Leg\", subInjury : undefined },\r\n        { value : [ 12 ], injury : \"Head\", subInjury : [\r\n            { value : [ 1, 2, 3 ], injury : \"Hideous Scar\" },\r\n            { value : [ 4, 5 ], injury : \"Blinded\" },\r\n            { value : [ 6 ], injury : \"Brain Damage\" }\r\n        ]}\r\n    ];\r\n\r\n    // create a dice pool\r\n    let diceResultPool = [];\r\n    \r\n    // get cover bonus\r\n    let coverBonus = html.find(\"#coverBonus\")[0] === undefined ? 0 : html.find(\"#coverBonus\")[0].value;\r\n\r\n    // get isGrettyDamage parameter\r\n    let isGrettyDamage = html.find(\"#isGrettyDamage\")[0] === undefined ? false : html.find(\"#isGrettyDamage\")[0].checked ? true : false;\r\n\r\n    // get damage modification\r\n    let damageMod = html.find(\"#damageMod\")[0] === undefined ? 0 : html.find(\"#damageMod\")[0].value;\r\n\r\n    // get ignore armor\r\n    let ignoreAmor = html.find(\"#ignoreArmor\")[0] === undefined ? false : html.find(\"#ignoreArmor\")[0].checked ? true : false;\r\n\r\n    // Roll Dices\r\n    for (let i = 0; i < successResultPool.length; i++) {\r\n        \r\n        let weaponDamage = weapon.data.data.damage;\r\n\r\n        // Downgrade weapon damage for minStr restrcitions\r\n        if (attackSkillName == \"Fighting\" && weapon.data.data.minStr != \"\" && diceStep.indexOf(weapon.data.data.minStr) > diceStep.indexOf((\"d\" + currentActor.data.data.attributes.strength.die.sides))) \r\n        {\r\n            weaponDamage = \"@str+1d\" + currentActor.data.data.attributes.strength.die.sides + \" + \" + damageMod;\r\n        }     \r\n\r\n        // Roll dices damages\r\n        diceResultPool.push({ type: \"damageRoll\", \r\n                                roll : new Roll(\r\n                                    weaponDamage.replace(\"@str\", \"1d\" + currentActor.data.data.attributes.strength.die.sides + \"x= +\" \r\n                                    + (currentActor.data.data.attributes.strength.die.modifier != \"0\" ? currentActor.data.data.attributes.strength.die.modifier : \"\")) \r\n                                    + \"x=\" + (successResultPool[i] == \"Raise\" ? \" + 1d6x=\" : \"\")\r\n                                    + \" + \" + damageMod\r\n                                ).roll(), raise : successResultPool[i] == \"Raise\" ? 1 : 0});\r\n    }\r\n\r\n    // Prepare template\r\n    let displayRollResultTemplate = ``;\r\n    let targetShaken = currentTarget.data.data.status.isShaken;\r\n\r\n    // Get armor equipped\r\n    let armorToughness = 0;\r\n    if (!ignoreAmor) currentTarget.items.filter((el) => el.data.type == \"armor\" && el.data.data.equipped).forEach((el) => armorToughness += parseInt(el.data.data.armor));\r\n\r\n    // Create roll result template\r\n    diceResultPool.forEach((el) => {\r\n        displayRollResultTemplate += `<div style=\"display: flex; flex-wrap: wrap; font-size: 16px; font-weight: bold\">`;\r\n        displayRollResultTemplate +=\r\n            `<div style=\"flex: 0 0 50px;\">\r\n                <div style=\"padding: 3px 0px 3px 0px; box-shadow: 0 0 2px #FFF inset; border-radius: 3px; ${ el.raise ? \"background-color: rgb(0, 200, 0, 0.35);\" : \"\" } \"><label title=\"${ el.roll.formula + \"\\n\" + el.roll.result }\" style=\"color: white;\">${ el.roll.total }</label></div>\r\n            </div>`;\r\n\r\n        // Calcul total toughness\r\n        let totalToughness = (parseInt(currentTarget.data.data.stats.toughness.value) \r\n                            + (parseInt(weapon.data.data.ap) > (parseInt(armorToughness) + parseInt(coverBonus)) ? 0 : (parseInt(armorToughness) + parseInt(coverBonus)) - parseInt(weapon.data.data.ap))\r\n                            + parseInt(currentTarget.data.data.stats.toughness.modifier));\r\n\r\n        // FOR VERSION OF SWADE SYSTEM WITH ARMOR IMPROVMENT\r\n        // let totalToughness = (parseInt(currentTarget.data.data.stats.toughness.value) \r\n        //                     + (parseInt(weapon.data.data.ap) > parseInt(currentTarget.data.data.stats.toughness.armor) ? 0 : parseInt(currentTarget.data.data.stats.toughness.armor) - parseInt(weapon.data.data.ap))\r\n        //                     + parseInt(currentTarget.data.data.stats.toughness.modifier));\r\n        \r\n        // Check if roll is better that toughness\r\n        if (el.roll.total >= totalToughness) {\r\n       \r\n            // Calcul wounds\r\n            let wounds = Math.floor(((el.roll.total - totalToughness) / 4)) + (targetShaken ? 1 : 0);\r\n\r\n            if (!targetShaken) {\r\n                displayRollResultTemplate +=\r\n                    `<div style=\"flex: 1 0 auto;\">\r\n                        <div style=\"padding: 3px 0px 3px 0px; box-shadow: 0 0 2px #FFF inset; border-radius: 3px; background-color: rgb(255,215,0, 0.35);\"><label title=\"\" style=\"color: white;\">Shaken</label></div>\r\n                    </div>`; \r\n            }\r\n            \r\n            if (wounds > 0)\r\n            {\r\n                displayRollResultTemplate +=\r\n                        `<div style=\"flex: 1 0 auto;\">\r\n                            <div style=\"padding: 3px 0px 3px 0px; box-shadow: 0 0 2px #FFF inset; border-radius: 3px; background-color: rgb(255, 0, 0, 0.35);\"><label title=\"\" style=\"color: white;\">${ wounds } Wounds</label></div>\r\n                        </div>`;\r\n                \r\n                if (isGrettyDamage && ((targetShaken && wounds > 1) || !targetShaken)) {\r\n\r\n                    let roll1 =new Roll(\"2d6\").roll().total;\r\n                    let roll2 =new Roll(\"1d6\").roll().total;\r\n                    \r\n                    let injury = criticalInjury.find((el) => el.value.includes(roll1));\r\n                    let subInjury =  injury.subInjury != undefined ? injury.subInjury.find((el) => el.value.includes(roll2)) : undefined;\r\n\r\n                    displayRollResultTemplate +=\r\n                        `<div style=\"flex: 1 0 auto;\">\r\n                            <div style=\"padding: 3px 0px 3px 0px; box-shadow: 0 0 2px #FFF inset; border-radius: 3px;\"><label title=\"\" style=\"color: white;\">${ subInjury == undefined ? injury.injury : subInjury.injury }</label></div>\r\n                        </div>`;\r\n                }\r\n            }\r\n             \r\n            targetShaken = true;\r\n        }else{\r\n            displayRollResultTemplate += \r\n                `<div style=\"flex: 1 0 auto;\">\r\n                    <div style=\"padding: 3px 0px 3px 0px; box-shadow: 0 0 2px #FFF inset; border-radius: 3px; background-color: rgb(0, 0, 255, 0.35);\"><label title=\"\" style=\"color: white;\">Hold</label></div>\r\n                </div>`;\r\n        }\r\n        displayRollResultTemplate += `</div>`;\r\n    });\r\n\r\n    // Chat Template\r\n    let chatTemplate = $(\r\n        `<div>\r\n            <div style=\"display: flex; align-items: center; margin-bottom: 10px;\">\r\n                <div style=\"width: 52px; flex: 0 0 52px;\">\r\n                    <img src=\"${weapon.data.img}\"></img>\r\n                </div>\r\n                <div style=\"padding-left: 5px;\">\r\n                    <span>Attack with weapon <b>${weapon.data.name}</b> hit the target <b>${currentTarget.data.name}</b></span>\r\n                </div>\r\n            </div>\r\n            ${ bennieUsed ? `<p style=\"text-align: center\"><b>One bennie used for reroll damage</b></p>` : \"\" }\r\n            <div style=\"border: 1px solid #999; display: flex; box-shadow: 0 0 2px #FFF inset; background: rgba(255, 255, 240, 0.8); margin-bottom: 5px; text-align: center; flex-wrap: wrap;\">\r\n                <div style=\"width: 50%; flex: 1 0 auto; padding-bottom: 2px; padding-top: 2px;\"><span>AP : </span><span>${ weapon.data.data.ap }</span></div>\r\n                <div style=\"width: 50%; flex: 1 0 auto; padding-bottom: 2px; padding-top: 2px;\" title=\"${ \"armor : \" + armorToughness + \"\\n\" + \"cover : \" + coverBonus }\"><span>Armor : </span><span> ${ (armorToughness + parseInt(coverBonus)) }</span></div>\r\n                <div style=\"width: 50%; flex: 1 0 auto; padding-bottom: 2px; padding-top: 2px;\"><span>Toughness : </span><span> ${ currentTarget.data.data.stats.toughness.value }</span></div>\r\n                <div style=\"width: 50%; flex: 1 0 auto; padding-bottom: 2px; padding-top: 2px;\"><span>Damage mod : </span><span>${ damageMod }</span></div>\r\n            </div>\r\n            <div style=\"border: 1px solid #999; border-radius: 3px; box-shadow: 0 0 2px #FFF inset; background: rgba(0, 0, 0, 0.1); text-align: center; margin-bottom: 10px;\">\r\n                <div style=\"display: flex; flex-wrap: wrap;\">\r\n                    <div style=\"box-shadow: 0 0 2px #FFF inset; display: flex; flex-direction: column; text-align: center; flex: 1 100 auto; width: 100%\">\r\n                        <div style=\"padding: 5px 0px 5px 0px; background: rgba(255, 255, 240, 0.8);\">\r\n                            <label><b>Result</b></label>\r\n                        </div>\r\n                        ${ displayRollResultTemplate }\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>`\r\n    );\r\n\r\n    // Apply bennie button and listener to chatTemplate if not critical failure\r\n    let bennieButtonTemplate = $(\r\n        `<div style=\"display: flex; padding-top: 5px;\">\r\n        <button id=\"reRollButton\"><center>Reroll with a Bennie</center></button>\r\n        </div>`\r\n    );\r\n\r\n    chatTemplate.append(bennieButtonTemplate);\r\n    \r\n    // Add event to chat message html element\r\n    addEventListenerOnHtmlElement(\"#reRollButton\", 'click', (e) => { \r\n        e.target.style.display = \"none\"; \r\n        params.bennieUsed = true;\r\n        damageCalculation(params);\r\n    }); \r\n    \r\n    // Displat chat template\r\n    // Check can use \"So Nice Dices\" mod effects\r\n    game.dice3d === undefined ? printMessage(chatTemplate[0].outerHTML) : game.dice3d.showForRoll(diceResultPool.map((el) => el.roll)).then(displayed => {\r\n        printMessage(chatTemplate[0].outerHTML);\r\n    });\r\n\r\n} // end damageCalculation","author":"siZAYn2xsyMeEsfz","img":"icons/svg/combat.svg","actorIds":[],"_id":"fBPcqH0Th44QV89u"}
